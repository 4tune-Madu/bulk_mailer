{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow p-4">
      <h3 class="mb-4 text-center"><i class="fas fa-envelope"></i> Send Email</h3>

      {% if error %}
        <div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> {{ error }}</div>
      {% endif %}
      {% if success %}
        <div class="alert alert-success"><i class="fas fa-check-circle"></i> {{ success }}</div>
      {% endif %}

      {% if user_accounts.exists %}
        <form id="send-email-form" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- Sender Email -->
          <div class="mb-3">
            <label for="sender_email" class="form-label">From</label>
            <select name="sender_email" id="sender_email" class="form-select" required>
              <option value="" disabled selected>-- Select sender email --</option>
              {% for account in user_accounts %}
                <option value="{{ account.id }}">{{ account.email }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Recipients -->
          <div class="mb-3">
            <label for="recipients" class="form-label">Recipients</label>
            <div id="recipients-container" class="d-flex flex-wrap border p-2 rounded"></div>
            <input type="text" id="recipient-input" class="form-control mt-2" placeholder="Type email and press Enter">
          </div>

          <!-- Subject -->
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input type="text" name="subject" id="subject" class="form-control" required>
          </div>

          <!-- Message -->
          <div class="mb-3">
            <label for="message" class="form-label">Message</label>
            <textarea name="message" id="message" class="form-control" rows="5" required></textarea>
          </div>

          <!-- Attachments -->
          <div class="mb-3">
            <label for="attachments" class="form-label">Attachments</label>
            <input type="file" id="attachments" name="attachments" class="form-control" multiple>
            <small class="text-muted">Click filename to preview. Use × to remove.</small>
            <ul id="attachment-list" class="list-group mt-2"></ul>
          </div>

          <!-- Hidden rebuilt file inputs -->
          <div id="final-attachments"></div>

          <button type="submit" class="btn btn-dark w-100">
            <i class="fas fa-paper-plane"></i> Send
          </button>
        </form>
      {% else %}
        <div class="alert alert-warning">
          ⚠️ You have no email accounts configured. Please 
          <a href="{% url 'add_email_account' %}">add one</a> first.
        </div>
      {% endif %}

      <p class="text-center mt-3">
        <a href="{% url 'home' %}">← Back to Home</a>
      </p>
    </div>
  </div>
</div>

<!-- Modal for file preview -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">File Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <iframe id="filePreviewFrame" src="" width="100%" height="600px" style="border:none;"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------------------
   Recipients handling
---------------------------- */
const recipientInput = document.getElementById("recipient-input");
const recipientsContainer = document.getElementById("recipients-container");
const form = document.getElementById("send-email-form");

recipientInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    const email = recipientInput.value.trim();
    if (email && validateEmail(email) && !isDuplicate(email)) {
      addRecipientTag(email);
      recipientInput.value = "";
    }
  }
});

function addRecipientTag(email) {
  const tag = document.createElement("span");
  tag.className = "badge bg-primary me-1 mb-1";
  tag.textContent = email;

  const removeBtn = document.createElement("span");
  removeBtn.className = "ms-2";
  removeBtn.style.cursor = "pointer";
  removeBtn.innerHTML = "&times;";

  const hiddenInput = document.createElement("input");
  hiddenInput.type = "hidden";
  hiddenInput.name = "recipients";
  hiddenInput.value = email;

  removeBtn.onclick = () => {
    recipientsContainer.removeChild(tag);
    hiddenInput.remove();
  };

  tag.appendChild(removeBtn);
  recipientsContainer.appendChild(tag);
  recipientsContainer.appendChild(hiddenInput);
}

function isDuplicate(email) {
  const existing = form.querySelectorAll("input[name='recipients']");
  return Array.from(existing).some(input => input.value === email);
}

function validateEmail(email) {
  const re = /\S+@\S+\.\S+/;
  return re.test(email);
}

/* ---------------------------
   Attachments handling
---------------------------- */
const attachmentsInput = document.getElementById("attachments");
const attachmentList = document.getElementById("attachment-list");
const previewFrame = document.getElementById("filePreviewFrame");
const finalAttachmentsDiv = document.getElementById("final-attachments");

let currentFiles = [];

attachmentsInput.addEventListener("change", () => {
  currentFiles = Array.from(attachmentsInput.files);
  renderFileList();
});

function renderFileList() {
  attachmentList.innerHTML = "";
  finalAttachmentsDiv.innerHTML = "";

  currentFiles.forEach((file, index) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";

    const fileName = document.createElement("span");
    fileName.style.cursor = "pointer";
    fileName.textContent = file.name;
    fileName.addEventListener("click", () => previewFile(file));

    const removeBtn = document.createElement("button");
    removeBtn.className = "btn btn-sm btn-outline-danger ms-2";
    removeBtn.textContent = "×";
    removeBtn.onclick = () => {
      currentFiles.splice(index, 1);
      renderFileList();
    };

    li.appendChild(fileName);
    li.appendChild(removeBtn);
    attachmentList.appendChild(li);
  });

  currentFiles.forEach(file => {
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.name = "attachments";
    fileInput.files = createFileList([file]);
    finalAttachmentsDiv.appendChild(fileInput);
  });
}

function previewFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    previewFrame.src = e.target.result;
    const modal = new bootstrap.Modal(document.getElementById("filePreviewModal"));
    modal.show();
  };
  reader.readAsDataURL(file);
}

function createFileList(files) {
  const dataTransfer = new DataTransfer();
  files.forEach(file => dataTransfer.items.add(file));
  return dataTransfer.files;
}
</script>
{% endblock %}
